{"ast":null,"code":"import { useEffect } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useActiveWeb3React } from '../../hooks';\nimport { useAddPopup, useBlockNumber } from '../application/hooks';\nimport { checkedTransaction, finalizeTransaction } from './actions';\nexport function shouldCheck(lastBlockNumber, tx) {\n  if (tx.receipt) return false;\n  if (!tx.lastCheckedBlockNumber) return true;\n  const blocksSinceCheck = lastBlockNumber - tx.lastCheckedBlockNumber;\n  if (blocksSinceCheck < 1) return false;\n  const minutesPending = (new Date().getTime() - tx.addedTime) / 1000 / 60;\n\n  if (minutesPending > 60) {\n    // every 10 blocks if pending for longer than an hour\n    return blocksSinceCheck > 9;\n  } else if (minutesPending > 5) {\n    // every 3 blocks if pending more than 5 minutes\n    return blocksSinceCheck > 2;\n  } else {\n    // otherwise every block\n    return true;\n  }\n}\nexport default function Updater() {\n  var _state$chainId;\n\n  const {\n    chainId,\n    library\n  } = useActiveWeb3React();\n  const lastBlockNumber = useBlockNumber();\n  const dispatch = useDispatch();\n  const state = useSelector(state => state.transactions);\n  const transactions = chainId ? (_state$chainId = state[chainId]) !== null && _state$chainId !== void 0 ? _state$chainId : {} : {}; // show popup on confirm\n\n  const addPopup = useAddPopup();\n  useEffect(() => {\n    if (!chainId || !library || !lastBlockNumber) return;\n    Object.keys(transactions).filter(hash => shouldCheck(lastBlockNumber, transactions[hash])).forEach(hash => {\n      library.getTransactionReceipt(hash).then(receipt => {\n        if (receipt) {\n          var _transactions$hash;\n\n          dispatch(finalizeTransaction({\n            chainId,\n            hash,\n            receipt: {\n              blockHash: receipt.blockHash,\n              blockNumber: receipt.blockNumber,\n              contractAddress: receipt.contractAddress,\n              from: receipt.from,\n              status: receipt.status,\n              to: receipt.to,\n              transactionHash: receipt.transactionHash,\n              transactionIndex: receipt.transactionIndex\n            }\n          }));\n          addPopup({\n            txn: {\n              hash,\n              success: receipt.status === 1,\n              summary: (_transactions$hash = transactions[hash]) === null || _transactions$hash === void 0 ? void 0 : _transactions$hash.summary\n            }\n          }, hash);\n        } else {\n          dispatch(checkedTransaction({\n            chainId,\n            hash,\n            blockNumber: lastBlockNumber\n          }));\n        }\n      }).catch(error => {\n        console.error(`failed to check transaction hash: ${hash}`, error);\n      });\n    });\n  }, [chainId, library, transactions, lastBlockNumber, dispatch, addPopup]);\n  return null;\n}","map":{"version":3,"sources":["C:/Users/marin/Desktop/bananaswap/src/state/transactions/updater.tsx"],"names":["useEffect","useDispatch","useSelector","useActiveWeb3React","useAddPopup","useBlockNumber","checkedTransaction","finalizeTransaction","shouldCheck","lastBlockNumber","tx","receipt","lastCheckedBlockNumber","blocksSinceCheck","minutesPending","Date","getTime","addedTime","Updater","chainId","library","dispatch","state","transactions","addPopup","Object","keys","filter","hash","forEach","getTransactionReceipt","then","blockHash","blockNumber","contractAddress","from","status","to","transactionHash","transactionIndex","txn","success","summary","catch","error","console"],"mappings":"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","sourcesContent":["import { useEffect } from 'react'\r\nimport { useDispatch, useSelector } from 'react-redux'\r\nimport { useActiveWeb3React } from '../../hooks'\r\nimport { useAddPopup, useBlockNumber } from '../application/hooks'\r\nimport { AppDispatch, AppState } from '../index'\r\nimport { checkedTransaction, finalizeTransaction } from './actions'\r\n\r\nexport function shouldCheck(\r\n  lastBlockNumber: number,\r\n  tx: { addedTime: number; receipt?: {}; lastCheckedBlockNumber?: number }\r\n): boolean {\r\n  if (tx.receipt) return false\r\n  if (!tx.lastCheckedBlockNumber) return true\r\n  const blocksSinceCheck = lastBlockNumber - tx.lastCheckedBlockNumber\r\n  if (blocksSinceCheck < 1) return false\r\n  const minutesPending = (new Date().getTime() - tx.addedTime) / 1000 / 60\r\n  if (minutesPending > 60) {\r\n    // every 10 blocks if pending for longer than an hour\r\n    return blocksSinceCheck > 9\r\n  } else if (minutesPending > 5) {\r\n    // every 3 blocks if pending more than 5 minutes\r\n    return blocksSinceCheck > 2\r\n  } else {\r\n    // otherwise every block\r\n    return true\r\n  }\r\n}\r\n\r\nexport default function Updater(): null {\r\n  const { chainId, library } = useActiveWeb3React()\r\n\r\n  const lastBlockNumber = useBlockNumber()\r\n\r\n  const dispatch = useDispatch<AppDispatch>()\r\n  const state = useSelector<AppState, AppState['transactions']>(state => state.transactions)\r\n\r\n  const transactions = chainId ? state[chainId] ?? {} : {}\r\n\r\n  // show popup on confirm\r\n  const addPopup = useAddPopup()\r\n\r\n  useEffect(() => {\r\n    if (!chainId || !library || !lastBlockNumber) return\r\n\r\n    Object.keys(transactions)\r\n      .filter(hash => shouldCheck(lastBlockNumber, transactions[hash]))\r\n      .forEach(hash => {\r\n        library\r\n          .getTransactionReceipt(hash)\r\n          .then(receipt => {\r\n            if (receipt) {\r\n              dispatch(\r\n                finalizeTransaction({\r\n                  chainId,\r\n                  hash,\r\n                  receipt: {\r\n                    blockHash: receipt.blockHash,\r\n                    blockNumber: receipt.blockNumber,\r\n                    contractAddress: receipt.contractAddress,\r\n                    from: receipt.from,\r\n                    status: receipt.status,\r\n                    to: receipt.to,\r\n                    transactionHash: receipt.transactionHash,\r\n                    transactionIndex: receipt.transactionIndex\r\n                  }\r\n                })\r\n              )\r\n\r\n              addPopup(\r\n                {\r\n                  txn: {\r\n                    hash,\r\n                    success: receipt.status === 1,\r\n                    summary: transactions[hash]?.summary\r\n                  }\r\n                },\r\n                hash\r\n              )\r\n            } else {\r\n              dispatch(checkedTransaction({ chainId, hash, blockNumber: lastBlockNumber }))\r\n            }\r\n          })\r\n          .catch(error => {\r\n            console.error(`failed to check transaction hash: ${hash}`, error)\r\n          })\r\n      })\r\n  }, [chainId, library, transactions, lastBlockNumber, dispatch, addPopup])\r\n\r\n  return null\r\n}\r\n"]},"metadata":{},"sourceType":"module"}